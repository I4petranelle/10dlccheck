<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SBG Rules Admin • 10DLC Checker</title>
  <style>
    :root{ --brand:#1C2D40; --accent:#FDB813; --bg:#F8FAFC; --border:#E2E8F0; --text:#111827; }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
    .wrap{width:min(1200px, 96vw); margin:0 auto; padding:20px}
    .card{background:#fff; border:1px solid var(--border); border-radius:16px; padding:18px; margin-top:16px}
    .h1{display:flex; align-items:center; gap:10px; font-weight:750; font-size:22px; color:var(--brand)}
    .h2{font-weight:650; font-size:16px; color:var(--brand)}
    .muted{color:#475569}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    input, textarea, select, button{font:inherit}
    input, textarea{width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:12px}
    textarea{min-height:110px}
    label{font-size:12px; color:#475569; display:block; margin-bottom:6px}
    .help{font-size:12px; color:#64748B; margin-top:6px}
    .pill{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px; color:#334155}
    .btn{border:none; border-radius:12px; padding:10px 14px; cursor:pointer}
    .btn-primary{background:var(--brand); color:#fff}
    .btn-primary:hover{opacity:.95}
    .btn-ghost{background:#fff; border:1px solid var(--border)}
    .btn-accent{background:var(--accent); color:#1C2D40; font-weight:700}
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    th,td{text-align:left; font-size:14px; padding:8px 10px; vertical-align:top}
    thead th{color:#475569}
    tbody tr{background:#fff; border:1px solid var(--border)}
    tbody tr td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
    .err{outline:2px solid #fca5a5}
    .foot{font-size:12px; color:#64748B; margin-top:24px}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:28px; height:28px; background:var(--brand); border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand" style="margin-bottom:12px">
      <div class="logo"></div>
      <div>
        <div class="h1">SBG Rules Admin</div>
        <div class="muted">Edit filtering rules & lender list for 10dlccheck.com</div>
      </div>
    </div>

    <!-- Controls / Key -->
    <div class="card">
      <div class="row">
        <div style="flex:1; min-width:360px">
          <label>Admin key</label>
          <input id="adminKey" placeholder="Paste the RULES_ADMIN_KEY your admin gave you" />
          <div class="help">Used only when saving changes. Store it locally with “Save key to browser”.</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn btn-ghost" onclick="saveKey()">Save key to browser</button>
        <button class="btn btn-primary" onclick="loadAll()">Load current data</button>
        <button class="btn btn-accent" onclick="saveAll()">Save all changes</button>
      </div>
      <div id="status" style="margin-top:8px; font-size:12px; color:#334155"></div>
    </div>

    <!-- Rules (stacked) -->
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div class="h2">Rules <span class="pill" id="rulesCount">0</span></div>
        <button class="btn btn-ghost" onclick="addRule()">+ Add rule</button>
      </div>
      <div class="help" style="margin-top:6px">
        <b>How to fill:</b> Pattern (regex like <code>loan|cash advance</code>), Category (e.g. <code>Restricted</code>, <code>Phishing</code>, <code>SHAFT</code>), Severity (<code>low/med/high</code>), Notes = reason.
      </div>
      <div style="overflow:auto; margin-top:10px">
        <table>
          <thead>
            <tr>
              <th style="width:70px">On</th>
              <th style="width:42%">Pattern</th>
              <th style="width:24%">Category</th>
              <th style="width:120px">Severity</th>
              <th>Notes</th>
              <th style="width:90px"></th>
            </tr>
          </thead>
          <tbody id="rulesBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Lenders (stacked) -->
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div class="h2">Lenders <span class="pill" id="lendersCount">0</span></div>
        <button class="btn btn-ghost" onclick="addLender()">+ Add lender</button>
      </div>
      <div class="help" style="margin-top:6px">
        <b>How to fill:</b> Name (canonical lender), Aliases (comma-separated), Status (<code>allowed/blocked/watch</code>), Notes = context.
      </div>
      <div style="overflow:auto; margin-top:10px">
        <table>
          <thead>
            <tr>
              <th style="width:34%">Name</th>
              <th>Aliases (comma‑sep)</th>
              <th style="width:170px">Status</th>
              <th>Notes</th>
              <th style="width:90px"></th>
            </tr>
          </thead>
          <tbody id="lendersBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Bulk JSON -->
    <div class="card">
      <div class="h2">Bulk JSON</div>
      <div class="help">Paste arrays. Import will <b>replace</b> current values in memory. You can export to download a backup.</div>
      <div class="row" style="gap:16px; margin-top:10px; flex-wrap:wrap">
        <div style="flex:1; min-width:460px">
          <label>Paste Rules (array)</label>
          <textarea id="bulkRules" placeholder='[{"id":"r-1","pattern":"loan|cash advance","category":"Restricted","severity":"med","enabled":true,"notes":"block risky loan phrasing"}]'></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-ghost" onclick="tryImport('rules')">Import Rules</button>
            <button class="btn btn-ghost" onclick="downloadJSON('rules.json', state.rules)">Export Rules</button>
          </div>
        </div>
        <div style="flex:1; min-width:460px">
          <label>Paste Lenders (array)</label>
          <textarea id="bulkLenders" placeholder='[{"id":"l-1","name":"Headway","aliases":["Headway","Headway Capital"],"status":"watch","notes":"monitor complaints"}]'></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-ghost" onclick="tryImport('lenders')">Import Lenders</button>
            <button class="btn btn-ghost" onclick="downloadJSON('lenders.json', state.lenders)">Export Lenders</button>
          </div>
        </div>
      </div>
    </div>

    <div class="foot">SBG Internal • v1.0</div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const uid = ()=> Math.random().toString(36).slice(2) + Date.now().toString(36);
  const ADMIN_KEY_LS = 'sbg_admin_key';
  const API = '/api/sbg-rules';

  const state = { rules: [], lenders: [] };

  function saveKey(){ localStorage.setItem(ADMIN_KEY_LS, $('adminKey').value.trim()); setStatus('Admin key saved.'); }
  function loadSavedKey(){ const k = localStorage.getItem(ADMIN_KEY_LS)||''; $('adminKey').value = k; }
  function setStatus(msg, ok=true){ const el=$('status'); el.textContent = msg; el.style.color = ok ? '#334155' : '#b91c1c'; }

  function validateRule(r){
    const errs=[];
    if(!r.id) errs.push('id');
    if(!r.pattern) errs.push('pattern');
    if(!r.category) errs.push('category');
    if(!['low','med','high'].includes(r.severity)) errs.push('severity');
    if(typeof r.enabled!=='boolean') errs.push('enabled');
    return errs;
  }
  function validateLender(l){
    const errs=[];
    if(!l.id) errs.push('id');
    if(!l.name) errs.push('name');
    if(!Array.isArray(l.aliases)) errs.push('aliases');
    if(!['allowed','blocked','watch'].includes(l.status)) errs.push('status');
    return errs;
  }

  function render(){
    const rb = $('rulesBody'); rb.innerHTML='';
    state.rules.forEach(r=>{
      const tr = document.createElement('tr');
      const bad = validateRule(r).length>0; if(bad) tr.classList.add('err');
      tr.innerHTML = `
        <td><input type="checkbox" ${r.enabled?'checked':''} data-k="enabled" title="Enable/disable this rule"></td>
        <td><input placeholder="e.g. loan|cash advance" value="${(r.pattern||'').replaceAll('"','&quot;')}" data-k="pattern"></td>
        <td><input placeholder="e.g. Restricted, Phishing, SHAFT" value="${(r.category||'').replaceAll('"','&quot;')}" data-k="category"></td>
        <td>
          <select data-k="severity" title="low / med / high">
            <option ${r.severity==='low'?'selected':''}>low</option>
            <option ${r.severity==='med'?'selected':''}>med</option>
            <option ${r.severity==='high'?'selected':''}>high</option>
          </select>
        </td>
        <td><input placeholder="e.g. block risky lender phrasing" value="${(r.notes||'').replaceAll('"','&quot;')}" data-k="notes"></td>
        <td><button class="btn btn-ghost" data-del>Delete</button></td>`;
      tr.querySelectorAll('input,select').forEach(inp=>{
        inp.addEventListener('change',()=>{
          const k = inp.getAttribute('data-k');
          if(k==='enabled') r.enabled = inp.checked; else r[k] = (k==='aliases') ? inp.value.split(',').map(s=>s.trim()).filter(Boolean) : inp.value;
          render();
        });
      });
      tr.querySelector('[data-del]').addEventListener('click',()=>{ state.rules = state.rules.filter(x=>x!==r); render(); });
      rb.appendChild(tr);
    });
    $('rulesCount').textContent = state.rules.length;

    const lb = $('lendersBody'); lb.innerHTML='';
    state.lenders.forEach(l=>{
      const tr = document.createElement('tr');
      const bad = validateLender(l).length>0; if(bad) tr.classList.add('err');
      tr.innerHTML = `
        <td><input placeholder="e.g. Headway" value="${(l.name||'').replaceAll('"','&quot;')}" data-k="name"></td>
        <td><input placeholder="e.g. Headway Capital, Headway" value="${(l.aliases||[]).join(', ').replaceAll('"','&quot;')}" data-k="aliases"></td>
        <td>
          <select data-k="status" title="allowed / blocked / watch">
            <option ${l.status==='allowed'?'selected':''}>allowed</option>
            <option ${l.status==='blocked'?'selected':''}>blocked</option>
            <option ${l.status==='watch'?'selected':''}>watch</option>
          </select>
        </td>
        <td><input placeholder="e.g. monitor complaints" value="${(l.notes||'').replaceAll('"','&quot;')}" data-k="notes"></td>
        <td><button class="btn btn-ghost" data-del>Delete</button></td>`;
      tr.querySelectorAll('input,select').forEach(inp=>{
        inp.addEventListener('change',()=>{
          const k = inp.getAttribute('data-k');
          if(k==='aliases') l.aliases = inp.value.split(',').map(s=>s.trim()).filter(Boolean); else l[k] = (k==='enabled')? inp.checked : inp.value;
          render();
        });
      });
      tr.querySelector('[data-del]').addEventListener('click',()=>{ state.lenders = state.lenders.filter(x=>x!==l); render(); });
      lb.appendChild(tr);
    });
    $('lendersCount').textContent = state.lenders.length;
  }

  function addRule(){ state.rules.unshift({id:uid(), pattern:'', category:'', severity:'low', enabled:true, notes:''}); render(); }
  function addLender(){ state.lenders.unshift({id:uid(), name:'', aliases:[], status:'watch', notes:''}); render(); }

  async function loadAll(){
    setStatus('Loading…');
    try{
      const res = await fetch(API, { method:'GET', cache:'no-store' });
      if(!res.ok) throw new Error('GET failed ' + res.status);
      const json = await res.json();
      state.rules = Array.isArray(json.rules)? json.rules : [];
      state.lenders = Array.isArray(json.lenders)? json.lenders : [];
      render(); setStatus('Loaded.');
    }catch(e){ setStatus('Error: '+ (e.message||e), false); }
  }

  async function saveAll(){
    setStatus('Saving…');
    const badR = state.rules.filter(r=>validateRule(r).length>0).length;
    const badL = state.lenders.filter(l=>validateLender(l).length>0).length;
    if(badR||badL){ setStatus('Fix highlighted rows before saving.', false); return; }
    try{
      const res = await fetch(API, {
        method:'PUT',
        headers:{ 'Content-Type':'application/json', 'X-Admin-Key': ($('adminKey').value||'').trim() },
        body: JSON.stringify({ rules: state.rules, lenders: state.lenders })
      });
      if(!res.ok){ const t = await res.text(); throw new Error('PUT failed '+res.status+' '+t); }
      setStatus('Saved.');
    }catch(e){ setStatus('Error: '+(e.message||e), false); }
  }

  function tryImport(kind){
    try{
      const raw = kind==='rules'? $('bulkRules').value : $('bulkLenders').value;
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) throw new Error('Expected an array');
      if(kind==='rules') state.rules = arr; else state.lenders = arr;
      render(); setStatus('Imported '+arr.length+' '+kind+'.');
    }catch(e){ setStatus('Import failed: '+(e.message||e), false); }
  }

  loadSavedKey();
  render();
</script>
</body>
</html>